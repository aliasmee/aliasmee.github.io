<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8" />

  
  <title>å¦‚ä½•å»ºç«‹ä¸€æ¡ç§æœ‰äº‘ä¸å…¬æœ‰äº‘ä¹‹é—´çš„è™šæ‹Ÿä¸“çº¿</title>

  
  





  
  <meta name="author" content="aliasmee" />
  <meta name="description" content="å…¬å¸æœ‰å¤šäº‘ç¯å¢ƒï¼Œæƒ³è¦ä¸€æ¡ä¸“çº¿ï¼Ÿæˆ–è€…å…¬å¸å…¶å®ƒè·¨ç‰©ç†åœ°åŒºåŠå…¬ï¼Œæƒ³è¦å®ç°å¯ä»¥è®¿é—®å½¼æ­¤å†…ç½‘ï¼Ÿé‚£ä¹ˆæœ¬æ–‡åº”è¯¥å¾ˆé€‚åˆä½ ã€‚

" />

  
  
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@aliasmeee" />
    <meta name="twitter:title" content="å¦‚ä½•å»ºç«‹ä¸€æ¡ç§æœ‰äº‘ä¸å…¬æœ‰äº‘ä¹‹é—´çš„è™šæ‹Ÿä¸“çº¿" />
    <meta name="twitter:description" content="å…¬å¸æœ‰å¤šäº‘ç¯å¢ƒï¼Œæƒ³è¦ä¸€æ¡ä¸“çº¿ï¼Ÿæˆ–è€…å…¬å¸å…¶å®ƒè·¨ç‰©ç†åœ°åŒºåŠå…¬ï¼Œæƒ³è¦å®ç°å¯ä»¥è®¿é—®å½¼æ­¤å†…ç½‘ï¼Ÿé‚£ä¹ˆæœ¬æ–‡åº”è¯¥å¾ˆé€‚åˆä½ ã€‚

" />
    <meta name="twitter:image" content="https://aliasmee.github.io/media/posts/build-a-site-to-site-vpn/cover.png" />
  

  
  <meta property="og:type" content="article" />
  <meta property="og:title" content="å¦‚ä½•å»ºç«‹ä¸€æ¡ç§æœ‰äº‘ä¸å…¬æœ‰äº‘ä¹‹é—´çš„è™šæ‹Ÿä¸“çº¿" />
  <meta property="og:description" content="å…¬å¸æœ‰å¤šäº‘ç¯å¢ƒï¼Œæƒ³è¦ä¸€æ¡ä¸“çº¿ï¼Ÿæˆ–è€…å…¬å¸å…¶å®ƒè·¨ç‰©ç†åœ°åŒºåŠå…¬ï¼Œæƒ³è¦å®ç°å¯ä»¥è®¿é—®å½¼æ­¤å†…ç½‘ï¼Ÿé‚£ä¹ˆæœ¬æ–‡åº”è¯¥å¾ˆé€‚åˆä½ ã€‚

" />
  <meta property="og:url" content="https://aliasmee.github.io/post/build-a-site-to-site-vpn/" />
  <meta property="og:image" content="https://aliasmee.github.io/media/posts/build-a-site-to-site-vpn/cover.png" />




<meta name="generator" content="Hugo 0.41" />


<link rel="canonical" href="https://aliasmee.github.io/post/build-a-site-to-site-vpn/" />
<link rel="alternative" href="https://aliasmee.github.io/index.xml" title="aliasmee&#39;s blog " type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />
<meta name="google-site-verification" content="dOpqXJeKRrCfsEkfUcoR0Ys0_e1wZ_-sZi_zoDpoc_c" />






<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="aliasmee&#39;s blog " />
<meta name="msapplication-tooltip" content="aliasmee&#39;s blog " />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="https://aliasmee.github.io/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="https://aliasmee.github.io/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://aliasmee.github.io/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="https://aliasmee.github.io/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="https://aliasmee.github.io/img/touch-icon-apple.png" />
<link rel="mask-icon" href="https://aliasmee.github.io/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="https://aliasmee.github.io/css/bundle.ff02473a9a.css" />


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="https://aliasmee.github.io/img/avatar.jpg" alt="Avatar">
  
  <h2 class="title">aliasmee&#39;s blog </h2>
  
  <p class="subtitle">DevOps | Kubernetes | Docker | Cloud | CICD </p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
            
            
            
              is-active
            ">
            <a href="https://aliasmee.github.io/">æ–‡å­—</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://github.com/aliasmee">GitHub</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://aliasmee.github.io/tags/">Tags</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://aliasmee.github.io/about/">About Me</a>
          </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      
      <li class="social-item">
        <a href="mailto:name@domain.com" title="Email"><span class="icon icon-email"></span></a>
      </li>

      
      <li class="social-item">
        <a href="//github.com/aliasmee" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      <li class="social-item">
        <a href="//twitter.com/aliasmeee" title="Twitter"><span class="icon icon-twitter"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="https://aliasmee.github.io/img/qrcode.jpg" title="Wechat"><span class="icon icon-wechat"></span></a>
      </li>

      <li class="social-item">
        <a href="//www.linkedin.com/in/linkedin_username" title="Linkedin"><span class="icon icon-linkedin"></span></a>
      </li>

      

      

      

      <li class="social-item">
        <a href="https://aliasmee.github.io/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">å¦‚ä½•å»ºç«‹ä¸€æ¡ç§æœ‰äº‘ä¸å…¬æœ‰äº‘ä¹‹é—´çš„è™šæ‹Ÿä¸“çº¿</h1>
      <p class="post-meta">@aliasmee Â· Mar 7, 2019 Â· 3 min read</p>
    </header>
    <article class="post-content"><p>å…¬å¸æœ‰å¤šäº‘ç¯å¢ƒï¼Œæƒ³è¦ä¸€æ¡ä¸“çº¿ï¼Ÿæˆ–è€…å…¬å¸å…¶å®ƒè·¨ç‰©ç†åœ°åŒºåŠå…¬ï¼Œæƒ³è¦å®ç°å¯ä»¥è®¿é—®å½¼æ­¤å†…ç½‘ï¼Ÿé‚£ä¹ˆæœ¬æ–‡åº”è¯¥å¾ˆé€‚åˆä½ ã€‚</p>

<p></p>

<h3 id="æ¦‚è¿°">æ¦‚è¿°</h3>

<blockquote>
<p>ä¸“çº¿ï¼Œä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ç†è§£ï¼Œå°±æ˜¯æ‹‰ä¸€æ¡ä¸“å±çº¿è·¯ï¼Œè¿æ¥ä½äºä¸åŒç‰©ç†åœ°åŒºçš„è®¾æ–½ã€‚åœ¨ç½‘ç»œä¸­ï¼Œæœ‰ç½‘ç»œä¸“çº¿ï¼Œéœ€è¦å‘è¿è¥å•†ç”³è¯·è´­ä¹°ã€‚
  ä»·æ ¼ä¸è²ã€‚</p>
</blockquote>

<p><em>ç°çŠ¶ï¼šç”±äºç›®å‰å¤§å¤šæ•°äº’è”ç½‘å…¬å¸çš„æœåŠ¡å™¨é›†ç¾¤å¤šä½äºå…¬æœ‰äº‘ä¹‹ä¸Šï¼Œä¸ç®¡æ˜¯åœ¨GCPã€AWSã€AlibabaCloudï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†ä¼ä¸šæœ‰è‡ªå·±çš„æœºæˆ¿ï¼Œ
è‡ªå·±æ¥ç»´æŠ¤ç®¡ç†äº‘æœåŠ¡å™¨ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä½ ä½¿ç”¨äº†å¤šä¸ªå…¬æœ‰äº‘æœåŠ¡ï¼Œæˆ–è€…ä¸€éƒ¨åˆ†è®¾æ–½åœ¨äº‘ä¸Šï¼Œä¸€éƒ¨åˆ†åœ¨ç§æœ‰æœºæˆ¿ï¼Œå¦‚ä½•æ‰“é€šè¿™ä¸¤å¤„æˆ–è€…è¯´
å¤šåœ°ä¹‹é—´çš„ç½‘ç»œå‘¢ï¼Ÿ</em></p>

<p><code>è§£å†³æ–¹æ¡ˆ</code>ï¼š</p>

<ul>
<li>ç”³è¯·ç‰©ç†ä¸“çº¿ï¼›</li>
<li>è´­ä¹°äº‘æœåŠ¡å•†æä¾›çš„VPNç½‘å…³æœåŠ¡ã€‚</li>
<li>è‡ªå»º</li>
</ul>

<p>ä¸‹é¢å°±è¯´ä¸‹å¦‚ä½•è‡ªå·±å»ºç«‹æ¡è™šæ‹Ÿä¸“çº¿ç½‘ç»œã€‚</p>

<h3 id="è¦æ±‚">è¦æ±‚</h3>

<ul>
<li>å…¬æœ‰äº‘ 1å°æœ‰å¤–ç½‘IPçš„äº‘ä¸»æœºï¼ˆç®€ç§° Aåœ°åŒºï¼‰</li>
<li>ç§æœ‰äº‘å†…éƒ¨ 1å°æœ‰å¤–ç½‘IPçš„ä¸»æœºï¼ˆç®€ç§° Båœ°åŒºï¼‰</li>
<li>ç³»ç»Ÿcentos/ubuntu,ç†è®ºä¸Šæ”¯æŒæ‰€ä»¥linuxå‘è¡Œç‰ˆï¼ˆraspberry piä¸Šæˆ‘è¯•éªŒè¿‡ä¹Ÿå¯ä»¥å“ˆï¼‰</li>
<li>ç½‘ç»œé˜²ç«å¢™ä¹‹é—´éœ€æ”¾è¡Œç«¯å£ UDP500 UDP4500</li>
</ul>

<h3 id="ç½‘ç»œæ‹“æ‰‘å›¾">ç½‘ç»œæ‹“æ‰‘å›¾</h3>

<p>Aï¼Bä¸¤åœ°ä¹‹é—´çš„ç½‘ç»œç»“æ„ï¼š

<figure>
    
        <img src="https://aliasmee.github.io/media/posts/build-a-site-to-site-vpn/net-topology.png" alt="ç½‘ç»œæ‹“æ‰‘" width="1000" />
    
    
    <figcaption>
        <h4>è™šæ‹Ÿä¸“çº¿æ‹“æ‰‘å›¾</h4>
        
    </figcaption>
    
</figure>
</p>

<p><em><code>Tipsï¼šå¦‚ä¸Šå›¾ï¼Œvpnä¸»æœºæ˜¯åœ¨ä¸¤å° routerä¹‹åï¼Œå®é™…æƒ…å†µæœ‰ä¸€ç«¯æ˜¯routerå†…æ ¸æœ¬èº«æ”¯æŒï¼ˆipsecåè®®ï¼‰ã€å¦ä¸€ç«¯æ˜¯natåçš„è‡ªå»ºä¸»æœºçš„ã€‚</code></em></p>

<h3 id="å®‰è£…">å®‰è£…</h3>

<p>ä»¥ä¸‹æ­¥éª¤åˆ’åˆ†ä¸ºAã€Bå®‰è£…ï¼ŒåŒä¸€è½¯ä»¶ï¼ˆstrongSwanï¼‰ï¼Œä¸åŒé…ç½®ã€‚</p>

<h4 id="aåœ°åŒºä¸»æœºå®‰è£…é…ç½®">Aåœ°åŒºä¸»æœºå®‰è£…é…ç½®</h4>

<p>1.å®‰è£… strongSwanè½¯ä»¶ï¼Œå¯å‚è€ƒæœ¬ç«™ç›¸å…³æ–‡ç« <a href="aliasmee.github.com">å¦‚ä½•ä½¿ç”¨Ansibleå¿«é€Ÿå»ºç«‹ä¸€ä¸ªåŸºäºstrongSwançš„VPNæœåŠ¡
</a></p>

<p>2.ä¿®æ”¹é…ç½®æ–‡ä»¶ ipsec.conf, å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">config setup
  uniqueids <span style="color:#f92672">=</span> no
<span style="color:#75715e">#  charondebug=&#34;all&#34;
</span><span style="color:#75715e"></span>  charondebug<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ike 2, knl 3, cfg 2&#34;</span>

conn a-to-b
  keyexchange<span style="color:#f92672">=</span>ikev1
  authby<span style="color:#f92672">=</span>secret
  type<span style="color:#f92672">=</span>tunnel
  left<span style="color:#f92672">=</span>%defaultroute
  leftid<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>.1.1.1
  right<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>.2.2.2
  leftsubnet<span style="color:#f92672">=</span><span style="color:#ae81ff">172</span>.16.0.0/16
  rightsubnet<span style="color:#f92672">=</span><span style="color:#ae81ff">172</span>.18.0.0/16
  ike<span style="color:#f92672">=</span>aes128-sha1-modp2048!
  esp<span style="color:#f92672">=</span>aes128-sha1-modp2048!
  keyingtries<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
  ikelifetime<span style="color:#f92672">=</span>1h
  lifetime<span style="color:#f92672">=</span>8h
  dpddelay<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>
  dpdtimeout<span style="color:#f92672">=</span><span style="color:#ae81ff">120</span>
  dpdaction<span style="color:#f92672">=</span>restart
  auto<span style="color:#f92672">=</span>route</code></pre></div>
<p>é’ˆå¯¹å‡ ä¸ªé…ç½®é€‰é¡¹æ³¨è§£ä¸‹ï¼Œè¯¦ç»†å¯å‚è€ƒå®˜ç½‘æ–‡æ¡£ï¼Œæˆ–è€…æœ¬ç«™å…¶å®ƒç›¸å…³æ–‡ç« ï¼š
* rightï¼šå¯¹ç«¯è·¯ç”±å™¨Public IP
* rightsubnetï¼šå¯¹ç«¯è·¯ç”±å™¨åé¢çš„ç½‘æ®µï¼ˆåˆç§°å…´è¶£æµï¼‰
* leftsubnetï¼šæœ¬ç«¯çš„ç½‘æ®µ
* typeï¼šéš§é“ç±»å‹</p>

<p>3.ä¿®æ”¹å¯†é’¥è®¤è¯æ–‡ä»¶/etc/ipsec.secretï¼Œåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¸€æ¡secretè®°å½•</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%any <span style="color:#ae81ff">2</span>.2.2.2 : PSK <span style="color:#e6db74">&#34;thisisatunnelpAsswWD&#34;</span></code></pre></div>
<p>4.é‡å¯æœåŠ¡</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ipsec restart</code></pre></div>
<h4 id="båœ°åŒºä¸»æœºå®‰è£…é…ç½®">Båœ°åŒºä¸»æœºå®‰è£…é…ç½®</h4>

<p>1.å®‰è£… strongSwanè½¯ä»¶ï¼Œå¯å‚è€ƒæœ¬ç«™ç›¸å…³æ–‡ç« <a href="aliasmee.github.com">å¦‚ä½•ä½¿ç”¨Ansibleå¿«é€Ÿå»ºç«‹ä¸€ä¸ªåŸºäºstrongSwançš„VPNæœåŠ¡
</a></p>

<p>2.ä¿®æ”¹é…ç½®æ–‡ä»¶ /etc/ipsec.confï¼ˆé»˜è®¤yumå®‰è£…è·¯å¾„ï¼‰, å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">config setup
  uniqueids <span style="color:#f92672">=</span> no

conn b-to-a
  keyexchange<span style="color:#f92672">=</span>ikev1
  authby<span style="color:#f92672">=</span>secret
	left<span style="color:#f92672">=</span>%any
	right<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>.2.2.2
	leftsubnet<span style="color:#f92672">=</span><span style="color:#ae81ff">172</span>.18.0.0/16
	rightsubnet<span style="color:#f92672">=</span><span style="color:#ae81ff">172</span>.16.0.0/16
	ike<span style="color:#f92672">=</span>aes128-sha1-modp2048!
	ikelifetime<span style="color:#f92672">=</span>28800s
	esp<span style="color:#f92672">=</span>aes128-sha1-modp2048!
	keylife<span style="color:#f92672">=</span>3600s
	rekeymargin<span style="color:#f92672">=</span>540s
	type<span style="color:#f92672">=</span>tunnel
	compress<span style="color:#f92672">=</span>no
	keyingtries<span style="color:#f92672">=</span>%forever
  auto<span style="color:#f92672">=</span>route</code></pre></div>
<p>3.ä¿®æ”¹å¯†é’¥è®¤è¯æ–‡ä»¶/etc/ipsec.secretï¼Œåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¸€æ¡secretè®°å½•</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">%any <span style="color:#ae81ff">1</span>.1.1.1 : PSK <span style="color:#e6db74">&#34;thisisatunnelpAsswWD&#34;</span></code></pre></div>
<p>4.é‡å¯æœåŠ¡</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ipsec restart</code></pre></div>
<h4 id="abä¸¤åœ°è”è°ƒæ£€æŸ¥æµ‹è¯•">ABä¸¤åœ°è”è°ƒæ£€æŸ¥æµ‹è¯•</h4>

<p>1.Aåœ° ä½¿ç”¨ipsec æŸ¥çœ‹è¿æ¥æƒ…å†µ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">a-to-b<span style="color:#f92672">[</span><span style="color:#ae81ff">65499</span><span style="color:#f92672">]</span>: ESTABLISHED <span style="color:#ae81ff">25</span> minutes ago, <span style="color:#ae81ff">1</span>.1.1.1<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>.1.1.1<span style="color:#f92672">]</span>...2.2.2.2<span style="color:#f92672">[</span><span style="color:#ae81ff">2</span>.2.2.2<span style="color:#f92672">]</span>
a-to-b<span style="color:#f92672">{</span><span style="color:#ae81ff">1</span><span style="color:#f92672">}</span>:  INSTALLED, TUNNEL, ESP in UDP SPIs: cfc0bd72_i c69f89fd_o
a-to-b<span style="color:#f92672">{</span><span style="color:#ae81ff">1</span><span style="color:#f92672">}</span>:   <span style="color:#ae81ff">172</span>.16.0.0/16 <span style="color:#f92672">===</span> <span style="color:#ae81ff">172</span>.18.0.0/16</code></pre></div>
<p>2.Båœ° è¿æ¥çŠ¶æ€</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Security Associations <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> up, <span style="color:#ae81ff">0</span> connecting<span style="color:#f92672">)</span>:
ali-to-office<span style="color:#f92672">[</span><span style="color:#ae81ff">255</span><span style="color:#f92672">]</span>: ESTABLISHED <span style="color:#ae81ff">25</span> minutes ago, <span style="color:#ae81ff">172</span>.18.1.222<span style="color:#f92672">[</span><span style="color:#ae81ff">2</span>.2.2.2<span style="color:#f92672">]</span>...1.1.1.1<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>.1.1.1<span style="color:#f92672">]</span>
ali-to-office<span style="color:#f92672">{</span><span style="color:#ae81ff">315</span><span style="color:#f92672">}</span>:  INSTALLED, TUNNEL, reqid <span style="color:#ae81ff">1</span>, ESP in UDP SPIs: c69f89fd_i cfc0bd72_o
ali-to-office<span style="color:#f92672">{</span><span style="color:#ae81ff">315</span><span style="color:#f92672">}</span>:   <span style="color:#ae81ff">172</span>.18.0.0/16 <span style="color:#f92672">===</span> <span style="color:#ae81ff">172</span>.16.0.0/16</code></pre></div>
<p>3.Aåœ° ping Båœ°åŒºä¸»æœº</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ping 172.18.1.164
</span><span style="color:#75715e"></span>PING <span style="color:#ae81ff">172</span>.18.1.164 <span style="color:#f92672">(</span><span style="color:#ae81ff">172</span>.18.1.164<span style="color:#f92672">)</span> <span style="color:#ae81ff">56</span><span style="color:#f92672">(</span><span style="color:#ae81ff">84</span><span style="color:#f92672">)</span> bytes of data.
<span style="color:#ae81ff">64</span> bytes from <span style="color:#ae81ff">172</span>.18.1.164: icmp_req<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">63</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>.44 ms
<span style="color:#ae81ff">64</span> bytes from <span style="color:#ae81ff">172</span>.18.1.164: icmp_req<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">63</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>.36 ms</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># traceroute 172.18.1.164
</span><span style="color:#75715e"></span>traceroute to <span style="color:#ae81ff">172</span>.18.1.164 <span style="color:#f92672">(</span><span style="color:#ae81ff">172</span>.18.1.164<span style="color:#f92672">)</span>, <span style="color:#ae81ff">30</span> hops max, <span style="color:#ae81ff">38</span> byte packets
 <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">172</span>.18.1.222 <span style="color:#f92672">(</span><span style="color:#ae81ff">172</span>.18.1.222<span style="color:#f92672">)</span>  <span style="color:#ae81ff">6</span>.270 ms  <span style="color:#ae81ff">6</span>.163 ms  <span style="color:#ae81ff">6</span>.065 ms
 <span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">172</span>.18.1.164 <span style="color:#f92672">(</span><span style="color:#ae81ff">172</span>.18.1.164<span style="color:#f92672">)</span>  <span style="color:#ae81ff">6</span>.398 ms  <span style="color:#ae81ff">6</span>.253 ms  <span style="color:#ae81ff">6</span>.421 ms</code></pre></div>
<p>4.Båœ° ping Aåœ°åŒºä¸»æœº</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ping <span style="color:#ae81ff">172</span>.16.193.21
PING <span style="color:#ae81ff">172</span>.16.193.21 <span style="color:#f92672">(</span><span style="color:#ae81ff">172</span>.16.193.21<span style="color:#f92672">)</span> <span style="color:#ae81ff">56</span><span style="color:#f92672">(</span><span style="color:#ae81ff">84</span><span style="color:#f92672">)</span> bytes of data.
<span style="color:#ae81ff">64</span> bytes from <span style="color:#ae81ff">172</span>.16.193.21: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">63</span> time<span style="color:#f92672">=</span><span style="color:#ae81ff">9</span>.73 ms</code></pre></div>
<h4 id="å…¶å®ƒé…ç½®">å…¶å®ƒé…ç½®</h4>

<p>å¦‚æœä½ ä¸æ˜¯ä½¿ç”¨æ¨èçš„æ–¹å¼å®‰è£…strongSwanï¼Œè¯·å‚è€ƒä¸‹é¢çš„å…¶å®ƒé…ç½®ã€‚</p>

<p>Aåœ°é˜²ç«å¢™é…ç½®1ï¼š <code>iptablesé…ç½®(æ–°å¢rules)</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -p tcp -m tcp --dport <span style="color:#ae81ff">22</span> -j ACCEPT
iptables -A INPUT -i eth0 -p esp -j ACCEPT
iptables -A INPUT -i eth0 -p ah -j ACCEPT
iptables -A INPUT -i eth0 -p udp -m udp --sport <span style="color:#ae81ff">500</span> --dport <span style="color:#ae81ff">500</span> -j ACCEPT
iptables -A INPUT -i eth0 -p udp -m udp --sport <span style="color:#ae81ff">4500</span> --dport <span style="color:#ae81ff">4500</span> -j ACCEPT
iptables -A INPUT -j REJECT --reject-with icmp-host-prohibited

iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -s <span style="color:#ae81ff">172</span>.18.0.0/16 -j ACCEPT
iptables -A FORWARD -j REJECT --reject-with icmp-host-prohibited

iptables -A POSTROUTING -t nat -s <span style="color:#ae81ff">172</span>.18.0.0/16 -d <span style="color:#ae81ff">172</span>.16.0.0/16 -j MASQUERADE</code></pre></div>
<p>Båœ°é˜²ç«å¢™é…ç½®2ï¼š <code>iptablesé…ç½®(æ–°å¢rules)</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -p tcp -m tcp --dport <span style="color:#ae81ff">22</span> -j ACCEPT
iptables -A INPUT -i eth0 -p esp -j ACCEPT
iptables -A INPUT -i eth0 -p ah -j ACCEPT
iptables -A INPUT -i eth0 -p udp -m udp --sport <span style="color:#ae81ff">500</span> --dport <span style="color:#ae81ff">500</span> -j ACCEPT
iptables -A INPUT -i eth0 -p udp -m udp --sport <span style="color:#ae81ff">4500</span> --dport <span style="color:#ae81ff">4500</span> -j ACCEPT
iptables -A INPUT -j REJECT --reject-with icmp-host-prohibited

iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
iptables -A FORWARD -s <span style="color:#ae81ff">172</span>.16.192.0/23 -d <span style="color:#ae81ff">172</span>.18.0.0/16 -j ACCEPT
iptables -A FORWARD -j REJECT --reject-with icmp-host-prohibited

iptables -A POSTROUTING -t nat -s <span style="color:#ae81ff">172</span>.16.0.0/16 -d <span style="color:#ae81ff">172</span>.18.0.0/16 -j MASQUERADE</code></pre></div>
<hr />

<p>ç³»ç»Ÿå†…æ ¸ç½‘ç»œè½¬å‘è®¾ç½®ï¼šAï¼Béƒ½è¦è®¾ç½®ï¼</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sysctl -w net.ipv4.ip_no_pmtu_disc<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
sysctl -w net.ipv4.ip_forward<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span></code></pre></div>
<hr />

<h3 id="ä¸­é€”é‡åˆ°çš„é—®é¢˜åˆ—è¡¨">ä¸­é€”é‡åˆ°çš„é—®é¢˜åˆ—è¡¨</h3>

<ul>
<li>é—®é¢˜1. ä¸¤ç«¯æˆåŠŸå»ºç«‹äº†è¿æ¥ï¼ŒBåœ° å¯ä»¥pingé€šAåœ°ä¸»æœºï¼Œä½†Aå´æ— æ³•pingé€šBæç¤º: <code>Destination Host Prohibite</code>ï¼Œå¦å¤–åœ¨Båœ°æŠ“åŒ…ï¼Œå´çœ‹åˆ°äº†Aåœ°ä¸»æœºå‘æ¥çš„icmpåŒ…ï¼Œå´æ²¡æœ‰replyçš„åŒ…ã€‚æ€€ç–‘æ˜¯é˜²ç«å¢™é—®é¢˜ã€‚</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># tcpdump -nni eth0 icmp
</span><span style="color:#75715e"></span>tcpdump: verbose output suppressed, use -v or -vv <span style="color:#66d9ef">for</span> full protocol decode
listening on eth0, link-type EN10MB <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>, capture size <span style="color:#ae81ff">262144</span> bytes
<span style="color:#ae81ff">17</span>:46:17.149502 IP <span style="color:#ae81ff">172</span>.16.193.21 &gt; <span style="color:#ae81ff">172</span>.18.1.164: ICMP echo request, id <span style="color:#ae81ff">31323</span>, seq <span style="color:#ae81ff">84</span>, length <span style="color:#ae81ff">64</span>
<span style="color:#ae81ff">17</span>:46:19.155821 IP <span style="color:#ae81ff">172</span>.16.193.21 &gt; <span style="color:#ae81ff">172</span>.18.1.164: ICMP echo request, id <span style="color:#ae81ff">31323</span>, seq <span style="color:#ae81ff">86</span>, length <span style="color:#ae81ff">64</span></code></pre></div>
<p>å°è¯•ä¿®æ”¹Båœ°VPNä¸»æœºä¸Šï¼ŒæŠŠAåœ°åŒºçš„å†…ç½‘ç½‘æ®µåŠ å…¥filteré‡Œå¹¶è®¾ç½®å…è®¸forwardã€‚å³ä¸Šé¢iptablesé…ç½®é‡Œå€’æ•°ç¬¬2æ¡è§„åˆ™ã€‚æœ€åä¸¤è¾¹éƒ½é€šäº†ã€‚å®Œç¾ğŸ˜„</p>

<h3 id="æ€»ç»“">æ€»ç»“</h3>

<p>è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå°½é‡æ—¥å¿—è¦è¯¦ç»†ä¸€ç‚¹ï¼ï¼ï¼ å»ºè®®å…ˆçœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œå†çœ‹å®¢æˆ·ç«¯æ—¥å¿—ã€‚</p></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="https://aliasmee.github.io/tags/%E9%9A%A7%E9%81%93"><span class="tag">éš§é“</span></a></li>
        
          <li><a href="https://aliasmee.github.io/tags/%E4%B8%93%E7%BA%BF"><span class="tag">ä¸“çº¿</span></a></li>
        
          <li><a href="https://aliasmee.github.io/tags/%E7%BD%91%E7%BB%9C"><span class="tag">ç½‘ç»œ</span></a></li>
        
          <li><a href="https://aliasmee.github.io/tags/%E8%BF%9E%E6%8E%A5%E6%B7%B7%E5%90%88%E4%BA%91"><span class="tag">è¿æ¥æ··åˆäº‘</span></a></li>
        
          <li><a href="https://aliasmee.github.io/tags/vpn%E7%BD%91%E5%85%B3"><span class="tag">VPNç½‘å…³</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        Â© This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International Licenseï¼Œplease give source if you wish to quote or reproduce.This post was published <strong>121</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "aliasmee" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  <footer class="site-footer">
  <p>Â© 2017-2019 aliasmee&#39;s blog </p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="https://aliasmee.github.io/js/bundle.d1288006cf.js"></script>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-120538012-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>





  </body>
</html>
